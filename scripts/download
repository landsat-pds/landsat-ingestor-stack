#!/bin/bash
source /etc/profile
set -eou pipefail
 
 
function usage() {
  echo ""
  echo "Download a Landsat scene from USGS."
  echo ""
  echo "Usage: ./download [entity id]"
  echo ""
}


productid=${1:-}


if [[ -z $productid ]]; then
  usage;
  exit 1;
fi


function onerror() {
  # The behavior of authentication against the usgs api appears to have changed
  # since the June 2020 maintenance. Attempt to login again
  rm -f /mnt/productid.tar.gz
  sleep $[ $RANDOM % 10 + 10]s
  exit 1
}
trap onerror EXIT
 
 
function download_landsat() {
  local productid=$1

  pathrow=$(echo $productid | cut -d '_' -f3)
  datestr=$(echo $productid | cut -d '_' -f4)

  path=${pathrow:0:3}
  row=${pathrow:3:6}
  year=${datestr:0:4}

  url="https://dds.cr.usgs.gov/highvolume/landsat_8/RT/${year}/${path}/${row}/${productid}.tar.gz"
  dstpath=/mnt/$productid.tar.gz

  echo "Downloading $productid from $url"
  t0=$(date +%s)
  curl --silent --fail --user ${USGS_USERNAME}:${USGS_PASSWORD} "$url" -o "$dstpath"
  t1=$(date +%s)
  echo "Took $(($t1 - $t0)) seconds to download $productid"

  echo "Copying $productid to s3://landsat-pds/tarq/"
  aws s3 cp $dstpath s3://landsat-pds/tarq/ --acl public-read
  rm -f $dstpath
}
 
download_landsat $productid
 
trap - EXIT
exit 0